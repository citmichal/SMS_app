<!DOCTYPE html>
<html>
    <head>
		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
		<script src="js/pgb.js"></script>
		<script src="cordova.js"></script>
		<link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css" />
		<script src="js/jquery-2.1.4.min.js"></script>
		<script src="js/jquery.mobile-1.4.5.min.js"></script>
        <title>SMS App UEK</title>
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="jquery-1.9.js"></script>

    </head>
    <body onload="onLoad()">
		<script language="JavaScript" type="text/javascript" src="jsbn.js"></script>
		<script language="JavaScript" type="text/javascript" src="jsbn2.js"></script>
		<script language="JavaScript" type="text/javascript" src="prng4.js"></script>
		<script language="JavaScript" type="text/javascript" src="rng.js"></script>
		<script language="JavaScript" type="text/javascript" src="rsa.js"></script>
		<script language="JavaScript" type="text/javascript" src="rsa2.js"></script>
        <script>
        function onLoad() {
            if(( /(ipad|iphone|ipod|android)/i.test(navigator.userAgent) )) {
                document.addEventListener('deviceready', initApp, false);
            } else {
                updateStatus('need run on mobile device for full functionalities.');
            }
        }

        var smsList = [];
        var interceptEnabled = false;

        function initApp() {
        	if (! SMS ) { alert( 'SMS plugin not ready' ); return; }
        	
            document.addEventListener('onSMSArrive', function(e){
				alert('akcja: nowy rozmowca');
            	var data = e.data;
            	smsList.push( data );
				if (data.body.substring(0,11) == 'InitSecure') {
					if (localStorage.getItem(data.address + 'n') === null) {
						alert('Robie nowy');
						var rsa = new RSAKey;
						rsa.generate(560,'3');
						localStorage.setItem(data.address + 'n', rsa.n.toString(16));
						localStorage.setItem(data.address + 'e', rsa.e.toString());
						localStorage.setItem(data.address + 'd', rsa.d.toString(16));
						localStorage.setItem(data.address + 'p', rsa.p.toString(16));
						localStorage.setItem(data.address + 'q', rsa.q.toString(16));
						localStorage.setItem(data.address + 'dmp1', rsa.dmp1.toString(16));
						localStorage.setItem(data.address + 'dmq1', rsa.dmq1.toString(16));
						localStorage.setItem(data.address + 'coeff', rsa.coeff.toString(16));
					}
					alert('po IF');
				
				
				
				}
				if(data.body.substring(0,10) == 'SecureMsg') {
				alert('akcja: szyfrowana wiadomosc');
				
					var rsa = new RSAKey;
					rsa.setPrivateEx(localStorage.getItem(data.address + 'n'), localStorage.getItem(data.address + 'e'), localStorage.getItem(data.address + 'd'), localStorage.getItem(data.address + 'p'), localStorage.getItem(data.address + 'q'), localStorage.getItem(data.address + 'dmp1'), localStorage.getItem(data.address + 'dmq1'), localStorage.getItem(data.address + 'coeff'));
					alert('Wiadomosc od: '+data.address+', tresc: '+rsa.decrypt(data.body));
					alert('gotowe')
				}
				/*if(data.body.substring(0,7) == 'Delete') {
					alert('Usuwam');
					localStorage.removeItem(data.address + 'n'), 
					localStorage.removeItem(data.address + 'e'), 
					localStorage.removeItem(data.address + 'd'),
					localStorage.removeItem(data.address + 'p'),
					localStorage.removeItem(data.address + 'q'),
					localStorage.removeItem(data.address + 'dmp1'),
					localStorage.removeItem(data.address + 'dmq1'),
					localStorage.removeItem(data.address + 'coeff'));
					alert('Skasowane');
				} */
				
			
				
            	updateStatus('SMS arrived, count: ' + smsList.length );
            	
            	var divdata = $('div#data');
            	divdata.html( divdata.html() + JSON.stringify( data ) );
            	
            });
        }
        
        function update( id, str ) {
        	$('div#' + id).html( str );
			alert('przyszlo');
        }
        function updateStatus( str ) {
        	$('div#status').html( str );
			alert('przyszlo');
        }
        function updateData( str ) {
        	$('div#data').html( str );
			alert('przyszlo');	
        }
         
        function wyslijZaproszenie() {
        	if(SMS) SMS.sendSMS($('input#rozmowca').val().trim(), 'InitSecure', function(){}, function(str){alert(str);});
        }
		function wyslijKasowanie() {
        	if(SMS) SMS.sendSMS($('input#rozmowca').val().trim(), 'Delete', function(){}, function(str){alert(str);});
        }
        function listSMS() {
    		updateData('');
    		
        	if(SMS) SMS.listSMS({}, function(data){
    			updateStatus('sms listed as json array');
    			//updateData( JSON.stringify(data) );
				
    			
    			var html = "";
        		if(Array.isArray(data)) {
        			for(var i in data) {
        				var sms = data[i];
        				smsList.push(sms);
        				html += sms.address + ": " + sms.body + "<br/>";
        			}
        		}
        		updateData( html );
        		
        	}, function(err){
        		updateStatus('error list sms: ' + err);
        	});
        }
        function deleteLastSMS() {
    		updateData('');

        	if(smsList.length == 0) {
        		updateStatus( 'no sms id to delete' );
        		return;
        	}
        	
    		var sms = smsList.pop();
    		
        	if(SMS) SMS.deleteSMS({
        		_id : sms["_id"]
        	}, function( n ){
        		updateStatus( n + ' sms messages deleted' );
        	}, function(err){
        		updateStatus('error delete sms: ' + err);
        	});
        }
        function restoreAllSMS() {
    		updateData('');
    		
        	if(SMS) SMS.restoreSMS(smsList, function( n ){
        		// clear the list if restore successfully
        		smsList.length = 0;
        		updateStatus(n + ' sms messages restored');
        		
        	}, function(err){
        		updateStatus('error restore sms: ' + err);
        	});
        }
        function startWatch() {
        	if(SMS) SMS.startWatch(function(){
        		update('watching', 'watching started');
        	}, function(){
        		updateStatus('failed to start watching');
        	});
        }
        function stopWatch() {
        	if(SMS) SMS.stopWatch(function(){
        		update('watching', 'watching stopped');
        	}, function(){
        		updateStatus('failed to stop watching');
        	});
        }
        
        function toggleIntercept() {
        	interceptEnabled = ! interceptEnabled;
        	
        	if(interceptEnabled) { // clear the list before we start intercept
        		smsList.length = 0;
        	}
        	
        	if(SMS) SMS.enableIntercept(interceptEnabled, function(){}, function(){});
        	
        	$('span#intercept').text( 'intercept ' + (interceptEnabled ? 'ON' : 'OFF') );
        	$('button#enable_intercept').text( interceptEnabled ? 'Disable' : 'Enable' );
        }
		
		function clearStorage() {
			localStorage.clear();
        }
			
        </script>
        <div id="fullpage">
            <p>Demo for SMS Plugin</p>

			To:<input type="text" size=16 value='510189591' id="rozmowca"/><br/>
			<button onclick="wyslijZaproszenie();">Zapos do konwersacji</button>
			<button onclick="wyslijKasowanie();">Skasuj klucze</button>
            <hr/>
            <button onclick="listSMS();">List Inboxx (recent 10)</button>
            <hr/>
            
			<button onclick="startWatch();">Start Watch</button>
            <button onclick="stopWatch();">Stop Watch</button>
            <br/><div id='watching'></div>
            <hr/>
                
            <span id='intercept'/>Intercept OFF</span><br/>
			<button id='enable_intercept' onclick='toggleIntercept();'>Enable</button> 
            <button onclick="restoreAllSMS();">Restore SMS</button>
            <button onclick="deleteLastSMS();">Delete Last SMS</button>
            <hr/>
            <button onclick="updateStatus('');updateData('');smsList.length=0;">Clear</button><br/>
            
            <button onclick="clearStorage();">Clear local storage</button>
            <div id='status'></div><hr/>
            <div id='data' style='text-align:left;'></div>
			
			
       </div>
    </body>
</html>